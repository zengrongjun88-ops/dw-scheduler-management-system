# 现代化调度系统需求文档

## 文档版本信息

| 版本号 | 修订日期 | 修订人 | 修订内容 |
|--------|----------|--------|----------|
| V1.0   | 2026-01-20 | 系统架构组 | 初始版本 |

---

## 1. 项目概述

### 1.1 项目背景

随着企业数据规模的持续增长和数据处理复杂度的提升，传统的任务调度系统已无法满足现代化数据处理场景的需求。本项目旨在构建一套高性能、高可用、易扩展的现代化调度系统，支持大规模任务的编排、调度与执行。

### 1.2 项目目标

- **高可用性**: 采用Master/Worker分布式架构，支持服务高可用和故障自动转移
- **高性能**: 基于Netty高性能通信框架，支持万级任务并发调度
- **易用性**: 提供可视化的任务开发、调试、监控界面，降低使用门槛
- **灵活性**: 支持多种任务类型（SQL、Shell、Python等），满足不同业务场景
- **可观测性**: 提供完整的任务执行链路追踪、日志查询、DAG可视化功能

### 1.3 适用范围

本系统适用于企业级数据处理场景，包括但不限于：
- 数据仓库ETL任务调度
- 大数据计算任务编排
- 定时报表生成
- 数据同步与迁移
- 机器学习工作流调度

---

## 2. 系统架构设计

### 2.1 整体架构

系统采用前后端分离架构，整体分为四层：

```
┌─────────────────────────────────────────────────────────┐
│                      前端展示层                          │
│    (任务管理界面 | 实例监控界面 | 服务器管理界面)         │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                      应用服务层                          │
│         (API Gateway | 权限认证 | 业务逻辑)             │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                      调度核心层                          │
│   ┌──────────────┐              ┌──────────────┐       │
│   │   Master     │ ←── Netty ──→│   Worker     │       │
│   │ - 实例生成   │              │ - 任务执行   │       │
│   │ - 任务调度   │              │ - 日志上报   │       │
│   │ - 日志收集   │              │ - 状态管理   │       │
│   └──────────────┘              └──────────────┘       │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                      数据存储层                          │
│  (元数据DB | 日志存储 | 配置中心 | 分布式锁)            │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术架构

#### 2.2.1 核心技术栈

- **前端技术**: React + TypeScript + Ant Design
- **后端技术**: Spring Boot + MyBatis
- **通信框架**: Netty (Master与Worker通信)
- **数据库**: MySQL (元数据) + ClickHouse/Elasticsearch (日志存储)
- **缓存**: Redis (分布式锁、任务队列)
- **消息队列**: RocketMQ/Kafka (可选，用于异步消息)
- **配置中心**: Nacos/Apollo
- **注册中心**: Nacos/Zookeeper

#### 2.2.2 Master/Worker架构

**Master节点职责**:
1. 任务实例生成与分配
2. 实例调度执行（根据调度策略分配到Worker）
3. 日志收集与聚合展示
4. Worker节点健康检查与管理
5. 失败任务重试与告警

**Worker节点职责**:
1. 接收Master分配的任务实例
2. 执行具体任务（SQL、Shell、Python等）
3. 实时上报执行日志到Master
4. 上报实例状态（运行中、成功、失败等）
5. 资源使用情况监控与上报

**Netty通信机制**:
- **协议设计**: 自定义二进制协议（魔数 + 版本 + 消息类型 + 消息体长度 + 消息体）
- **消息类型**: 心跳、任务分配、状态上报、日志上报、取消任务等
- **序列化**: Protobuf/JSON（可配置）
- **通信模式**: 长连接 + 心跳保活
- **负载均衡**: 基于Worker负载情况（CPU、内存、任务数）动态分配

---

## 3. 功能需求详细设计

### 3.1 任务管理模块

任务管理是调度系统的核心模块，提供任务的全生命周期管理能力。

#### 3.1.1 任务目录管理

**功能描述**:
采用树形目录结构管理任务，支持多级目录嵌套，便于任务分类与权限管理。

**功能要求**:

1. **目录树操作**
   - 支持创建、重命名、删除、移动目录
   - 支持拖拽方式调整目录层级
   - 支持目录搜索与快速定位
   - 目录深度建议不超过5层

2. **权限控制**
   - 目录级别权限继承
   - 支持设置目录可见性（公开/私有/指定人员）
   - 支持目录级别的操作权限（查看/编辑/执行/管理）

3. **目录属性**
   - 目录名称、描述
   - 责任人、创建人、创建时间
   - 包含任务数量统计

#### 3.1.2 数据开发

**功能描述**:
提供在线IDE环境，支持SQL、Shell等脚本的编写、调试与执行。

**SQL开发能力**:

1. **代码编辑器**
   - 语法高亮（支持多种SQL方言：MySQL、Hive、SparkSQL、ClickHouse等）
   - 智能提示（表名、字段名、函数名）
   - 语法检查与错误提示
   - 代码格式化与美化
   - 支持SQL模板与代码片段

2. **调试功能**
   - 在线执行SQL（限制返回行数，默认1000行）
   - 执行计划查看
   - 查询耗时统计
   - 结果集预览与导出（CSV、Excel）
   - 语法校验（不实际执行）

3. **数据源管理**
   - 支持多数据源配置（MySQL、Hive、ClickHouse等）
   - 数据源连接测试
   - 表结构浏览与字段查询
   - 数据源权限控制

**Shell脚本开发能力**:

1. **代码编辑器**
   - Bash语法高亮
   - 变量与函数提示
   - 常用命令智能补全
   - 脚本模板库

2. **调试功能**
   - 在线执行Shell脚本
   - 执行日志实时查看
   - 脚本语法检查
   - 支持传入测试参数

3. **安全限制**
   - 禁止执行危险命令（rm -rf、dd等）
   - 脚本执行超时控制
   - 资源使用限制（内存、CPU）

**执行日志查看**:

1. **日志展示**
   - 实时日志流展示（WebSocket）
   - 日志关键字高亮（ERROR、WARN、INFO）
   - 日志筛选（按级别、时间范围、关键字）
   - 支持下载完整日志

2. **日志存储**
   - 结构化日志存储（时间、级别、内容）
   - 日志保留策略（默认保留30天）
   - 大日志分片存储与加载

#### 3.1.3 任务配置

**基础属性配置**:

| 配置项 | 说明 | 是否必填 | 示例 |
|--------|------|----------|------|
| 任务名称 | 任务的唯一标识名称 | 是 | daily_user_report |
| 任务描述 | 任务的详细说明 | 否 | 每日用户行为报表生成 |
| 任务类型 | SQL/Shell/Python/Spark等 | 是 | SQL |
| 责任人 | 任务负责人（多选） | 是 | zhangsan@company.com |
| 所属主题 | 业务主题分类 | 否 | 用户分析 |
| 优先级 | HIGH/MEDIUM/LOW | 否 | HIGH |
| 超时时间 | 任务执行超时时长（分钟） | 是 | 120 |
| 失败重试次数 | 失败后自动重试次数 | 否 | 3 |
| 重试间隔 | 重试间隔时间（分钟） | 否 | 5 |

**调度配置**:

1. **调度类型**
   - **Cron调度**: 支持标准Cron表达式（秒 分 时 天 月 周）
     - 示例: `0 0 2 * * ?` (每天凌晨2点执行)
   - **依赖调度**: 依赖上游任务完成后触发
   - **手动触发**: 仅支持手动执行
   - **API调度**: 通过API接口触发

2. **调度时间配置**
   - 生效开始时间
   - 生效结束时间（可选）
   - 调度时间偏移量（分钟/小时/天）
     - 示例: 偏移量-1天，表示执行昨天的数据

3. **数据时间配置**
   - 业务日期表达式: `${yyyyMMdd}`, `${yyyyMMdd-1}`
   - 支持自定义业务日期格式
   - 支持数据回补时的日期参数传递

**执行配置**:

1. **资源配置**
   - 指定Worker执行分组（生产/测试/开发）
   - CPU核数限制
   - 内存限制（MB）
   - 磁盘空间要求

2. **并发控制**
   - 是否允许并发执行（同一任务多个实例同时运行）
   - 最大并发实例数

3. **告警配置**
   - 失败告警（邮件/短信/钉钉/企业微信）
   - 超时告警
   - 执行耗时告警（超过历史平均值N倍）
   - 告警接收人配置

#### 3.1.4 依赖管理

**上游依赖配置**:

1. **依赖类型**
   - **强依赖**: 上游任务必须成功完成
   - **弱依赖**: 上游任务完成即可（忽略成功/失败状态）
   - **条件依赖**: 基于上游任务输出结果决定是否执行

2. **依赖配置界面**
   - 支持搜索并添加依赖任务
   - 支持批量添加/删除依赖
   - 依赖关系可视化展示
   - 循环依赖检测与提示

3. **跨周期依赖**
   - 支持依赖上游任务的不同周期实例
   - 示例: 今日任务依赖昨日任务完成

**下游依赖展示**:

1. **下游任务列表**
   - 展示所有依赖当前任务的下游任务
   - 支持跳转到下游任务详情
   - 影响范围分析（变更当前任务影响多少下游）

2. **依赖链路追踪**
   - 完整依赖链路可视化
   - 支持多级依赖展开
   - 关键路径高亮显示

**依赖策略**:

1. **等待策略**
   - 最长等待时间（超时后标记为失败）
   - 上游失败时的处理策略（终止/跳过/继续）

2. **自依赖处理**
   - 支持任务依赖自身上一周期实例
   - 首次执行时的处理逻辑

---

### 3.2 任务列表模块

#### 3.2.1 任务搜索

**搜索维度**:

| 搜索字段 | 搜索方式 | 说明 |
|---------|---------|------|
| 任务名称 | 模糊匹配 | 支持拼音首字母搜索 |
| 任务ID | 精确匹配 | 数字ID |
| 任务类型 | 多选下拉 | SQL/Shell/Python等 |
| 责任人 | 多选下拉 | 支持搜索用户 |
| 所属主题 | 多选下拉 | 业务主题分类 |
| 所属目录 | 树形选择 | 包含子目录 |
| 任务状态 | 多选 | 启用/禁用/开发中 |
| 创建时间 | 时间范围 | 起始时间-结束时间 |
| 更新时间 | 时间范围 | 起始时间-结束时间 |

**搜索功能**:
- 支持组合搜索（多条件AND关系）
- 搜索历史记录（最近10条）
- 保存常用搜索条件为快捷筛选
- 搜索结果导出（Excel/CSV）

#### 3.2.2 任务列表展示

**列表字段**:

| 字段名称 | 说明 | 操作 |
|---------|------|------|
| 任务ID | 系统自动生成 | 支持复制 |
| 任务名称 | 可点击查看详情 | 跳转任务详情页 |
| 任务类型 | 图标+文字展示 | - |
| 责任人 | 显示用户姓名 | 点击查看用户信息 |
| 所属主题 | 标签形式展示 | - |
| 调度时间 | Cron表达式展示 | 悬浮显示下次执行时间 |
| 任务状态 | 启用/禁用/开发中 | 快速切换状态 |
| 最近执行状态 | 成功/失败/运行中 | 点击查看实例详情 |
| 最近执行时间 | yyyy-MM-dd HH:mm:ss | - |
| 更新时间 | yyyy-MM-dd HH:mm:ss | - |
| 操作 | 操作按钮组 | 编辑/执行/查看日志/删除 |

**列表功能**:
1. **排序功能**
   - 支持按任务ID、更新时间、执行时间等字段排序
   - 默认按更新时间倒序

2. **分页功能**
   - 支持10/20/50/100条每页
   - 显示总条数
   - 支持快速跳转页码

3. **批量操作**
   - 批量启用/禁用
   - 批量删除
   - 批量修改责任人
   - 批量导出

4. **列配置**
   - 支持自定义显示列
   - 支持拖拽调整列顺序
   - 支持固定列（左侧/右侧）

#### 3.2.3 DAG依赖关系展示

**可视化展示**:

1. **DAG图渲染**
   - 采用自顶向下或自左向右布局
   - 节点表示任务，边表示依赖关系
   - 支持缩放、拖拽、平移操作
   - 技术选型: AntV G6 / ECharts Graph

2. **节点信息**
   - 节点颜色区分任务状态（运行中/成功/失败/等待）
   - 节点形状区分任务类型（SQL/Shell等）
   - 悬浮显示节点详细信息
     - 任务名称、类型、责任人
     - 调度时间、执行耗时
     - 上下游任务数量

3. **交互功能**
   - 点击节点跳转任务详情
   - 双击节点展开上下游依赖
   - 右键菜单: 查看日志/手动执行/编辑任务
   - 支持搜索节点并高亮定位
   - 支持DAG图导出（PNG/SVG）

4. **依赖层级控制**
   - 默认展示±1层依赖
   - 支持展开到±2、±3或全部依赖
   - 大规模DAG图性能优化（虚拟渲染、分层加载）

**依赖分析**:

1. **影响分析**
   - 分析当前任务变更影响的下游任务数量
   - 高亮显示关键路径
   - 预估影响范围的执行时长

2. **依赖检查**
   - 检测循环依赖
   - 检测孤立节点（无依赖且无下游）
   - 检测过长依赖链（超过N层）

#### 3.2.4 执行实例信息

**实例概览**:

1. **最近实例列表**
   - 显示最近10次执行实例
   - 字段: 实例ID、执行时间、状态、耗时、操作
   - 支持快速查看日志
   - 支持实例重跑

2. **实例统计**
   - 最近7天/30天成功率
   - 平均执行耗时趋势图
   - 失败次数统计
   - 执行次数趋势

3. **实例日志快速查看**
   - 列表中直接展开日志（最近500行）
   - 支持查看完整日志（跳转实例详情页）
   - 错误日志高亮显示

---

### 3.3 实例管理模块

#### 3.3.1 实例搜索

**搜索维度**:

| 搜索字段 | 搜索方式 | 说明 |
|---------|---------|------|
| 实例ID | 精确匹配 | 雪花ID或UUID |
| 实例名称 | 模糊匹配 | 任务名称_业务日期 |
| 任务ID | 精确匹配 | 关联的任务ID |
| 任务名称 | 模糊匹配 | 任务名称搜索 |
| 执行时间 | 时间范围 | 起始时间-结束时间 |
| 业务日期 | 日期范围 | 数据业务日期 |
| 实例状态 | 多选 | 等待中/运行中/成功/失败/已取消 |
| 责任人 | 多选下拉 | 任务责任人 |
| 任务类型 | 多选 | SQL/Shell/Python等 |
| 执行Worker | 下拉选择 | 执行节点IP |
| 触发方式 | 多选 | 自动调度/手动触发/API触发/补数据 |

**高级搜索**:
- 执行耗时范围筛选（分钟）
- 重试次数筛选
- 是否告警过滤
- 组合搜索条件保存为视图

#### 3.3.2 实例列表展示

**列表字段**:

| 字段名称 | 说明 | 操作 |
|---------|------|------|
| 实例ID | 唯一标识 | 支持复制 |
| 任务名称 | 关联任务 | 点击跳转任务详情 |
| 业务日期 | 数据日期 | 格式: yyyy-MM-dd |
| 实例状态 | 状态标签 | 颜色区分: 成功(绿)/失败(红)/运行中(蓝)/等待(灰) |
| 触发方式 | 触发类型 | 自动/手动/API/补数据 |
| 开始时间 | 实例开始执行时间 | yyyy-MM-dd HH:mm:ss |
| 结束时间 | 实例执行结束时间 | yyyy-MM-dd HH:mm:ss |
| 执行耗时 | 执行时长 | HH:mm:ss 或 N分钟 |
| 执行Worker | 执行节点 | IP地址或节点名称 |
| 重试次数 | 已重试次数/最大次数 | 0/3 |
| 责任人 | 任务责任人 | - |
| 操作 | 操作按钮组 | 查看日志/重跑/终止/查看详情 |

**列表功能**:

1. **状态实时更新**
   - 运行中实例状态自动刷新（10秒轮询或WebSocket推送）
   - 执行耗时实时更新

2. **批量操作**
   - 批量重跑失败实例
   - 批量终止运行中实例
   - 批量删除历史实例

3. **快速筛选**
   - 快捷筛选: 运行中/今日失败/今日成功/等待中
   - 状态统计: 显示各状态实例数量

#### 3.3.3 实例详情页

**基础信息**:

| 信息项 | 说明 |
|-------|------|
| 实例ID | 唯一标识 |
| 任务ID/任务名称 | 关联任务（可跳转） |
| 实例状态 | 实时状态 |
| 业务日期 | 数据业务日期 |
| 触发方式 | 调度/手动/API |
| 开始时间 | 实际开始执行时间 |
| 结束时间 | 执行结束时间 |
| 执行耗时 | 总耗时 |
| 执行节点 | Worker IP地址 |
| 重试次数 | 当前重试次数 |
| 优先级 | HIGH/MEDIUM/LOW |

**实例执行日志**:

1. **日志查看器**
   - 支持日志实时滚动（运行中实例）
   - 支持日志关键字搜索与高亮
   - 支持按日志级别筛选（INFO/WARN/ERROR）
   - 支持日志下载（TXT/LOG格式）
   - 大日志分页加载（每次加载1000行）

2. **日志分析**
   - 自动提取ERROR级别日志
   - 错误堆栈折叠显示
   - SQL执行日志格式化显示
   - 日志行号显示

**实例属性**:

展示任务配置快照（实例执行时的任务配置）:
- 任务类型
- 调度时间
- 超时设置
- 重试配置
- 资源配置
- 告警配置
- 参数配置（运行时参数）

**操作日志**:

记录实例的所有操作历史:

| 时间 | 操作人 | 操作类型 | 操作详情 |
|-----|-------|---------|---------|
| 2026-01-20 10:00:00 | 系统 | 创建实例 | 自动调度生成 |
| 2026-01-20 10:05:00 | 系统 | 分配Worker | 分配到Worker-192.168.1.10 |
| 2026-01-20 10:05:05 | 系统 | 开始执行 | 执行开始 |
| 2026-01-20 10:30:00 | 系统 | 执行失败 | 数据库连接超时 |
| 2026-01-20 10:35:00 | zhangsan | 手动重跑 | - |
| 2026-01-20 11:00:00 | 系统 | 执行成功 | - |

**DAG图展示**:

1. **实例级DAG图**
   - 展示当前实例及其上下游实例的执行情况
   - 节点颜色表示实例状态（成功/失败/运行中/等待）
   - 支持点击节点跳转到对应实例详情
   - 显示依赖等待情况

2. **执行链路**
   - 关键路径高亮
   - 显示每个节点的执行耗时
   - 阻塞任务提示（等待上游完成）

**代码查看**:

1. **执行代码快照**
   - 展示实例执行时的任务代码
   - 代码语法高亮
   - 支持代码对比（与当前最新代码对比）
   - 只读模式

2. **参数替换后的代码**
   - 展示参数替换后的实际执行代码
   - 如: `${yyyyMMdd-1}` 替换为 `20260119`

**实例操作**:

1. **重跑**
   - 重新执行该实例
   - 支持修改运行参数后重跑
   - 重跑后生成新的实例ID

2. **终止**
   - 终止运行中的实例
   - 发送终止命令到Worker
   - 记录终止原因

3. **查看上下游**
   - 快速定位上下游实例
   - 批量操作上下游实例（批量重跑/终止）

---

### 3.4 服务器管理模块

#### 3.4.1 服务器搜索

**搜索维度**:

| 搜索字段 | 搜索方式 | 说明 |
|---------|---------|------|
| IP地址 | 精确/模糊 | 服务器IP |
| 服务器名称 | 模糊匹配 | 自定义名称 |
| 服务器角色 | 多选 | Master/Worker/Master+Worker |
| 资源分组 | 多选 | 生产/测试/开发 |
| 服务器状态 | 多选 | 在线/离线/故障 |
| 创建时间 | 时间范围 | - |

#### 3.4.2 服务器列表展示

**列表字段**:

| 字段名称 | 说明 | 展示内容 |
|---------|------|---------|
| 服务器ID | 唯一标识 | 自增ID |
| IP地址 | 内网IP | 192.168.1.10 |
| 服务器名称 | 自定义名称 | worker-prod-01 |
| 服务器角色 | Master/Worker | 标签展示 |
| 资源分组 | 环境分组 | 生产/测试/开发 |
| 服务器状态 | 在线状态 | 在线(绿)/离线(灰)/故障(红) |
| CPU使用率 | 实时CPU | 进度条+百分比 |
| 内存使用率 | 实时内存 | 进度条+百分比 |
| 磁盘使用率 | 磁盘空间 | 进度条+百分比 |
| 运行任务数 | Worker当前任务数 | 数字 |
| 最大任务数 | Worker最大并发 | 数字 |
| 最后心跳时间 | 最后一次心跳 | yyyy-MM-dd HH:mm:ss |
| 创建时间 | 服务器注册时间 | yyyy-MM-dd HH:mm:ss |
| 操作 | 操作按钮 | 查看详情/编辑/禁用/删除 |

**列表功能**:

1. **实时监控**
   - 服务器状态实时刷新（30秒轮询）
   - 资源使用率实时更新
   - 离线告警提示

2. **批量操作**
   - 批量禁用/启用
   - 批量修改资源分组
   - 批量导出服务器信息

#### 3.4.3 服务器详情

**基础信息**:
- IP地址、主机名、操作系统
- CPU核数、内存大小、磁盘大小
- 服务器角色、资源分组
- 注册时间、最后心跳时间

**资源监控**:

1. **实时监控**
   - CPU使用率曲线图（最近1小时）
   - 内存使用率曲线图
   - 磁盘IO曲线图
   - 网络IO曲线图

2. **历史监控**
   - 支持查看最近1天/7天/30天的监控数据
   - 支持导出监控数据

**运行任务列表**:

展示该Worker当前正在执行的任务实例:
- 任务名称、实例ID
- 开始时间、已执行时长
- 任务优先级
- 支持终止任务操作

**任务执行历史**:

统计该Worker的任务执行情况:
- 今日执行任务数
- 今日成功/失败任务数
- 最近执行的任务列表（最近50条）

**配置管理**:

1. **Worker配置**
   - 最大并发任务数
   - 资源预留配置（预留多少CPU/内存给系统）
   - 支持的任务类型
   - 是否允许调度新任务

2. **告警配置**
   - CPU使用率告警阈值
   - 内存使用率告警阈值
   - 磁盘使用率告警阈值
   - 离线告警（多久未心跳算离线）

---

## 4. 调度核心设计

### 4.1 Master节点详细设计

#### 4.1.1 任务实例生成

**生成策略**:

1. **定时扫描**
   - 每分钟扫描一次待生成实例的任务
   - 根据Cron表达式计算下次执行时间
   - 提前5分钟生成实例（可配置）

2. **实例生成规则**
   - 实例ID生成: 雪花算法或UUID
   - 实例名称: `{任务名称}_{业务日期}_{实例ID后6位}`
   - 业务日期计算: 根据调度时间+偏移量计算
   - 参数替换: 替换业务日期、系统变量等参数

3. **幂等性保证**
   - 基于任务ID+业务日期+调度时间唯一索引
   - 防止重复生成实例
   - 分布式锁保证并发安全

#### 4.1.2 实例调度执行

**调度队列设计**:

1. **优先级队列**
   - 高优先级队列（HIGH）
   - 中优先级队列（MEDIUM）
   - 低优先级队列（LOW）
   - 优先调度高优先级任务

2. **依赖检查**
   - 检查上游任务实例是否完成
   - 支持强依赖、弱依赖、条件依赖
   - 依赖超时处理

3. **Worker选择策略**
   - **负载均衡策略**:
     - 轮询（Round Robin）
     - 加权轮询（根据Worker性能）
     - 最少任务数优先
     - 随机
   - **资源匹配**:
     - 根据任务资源需求选择Worker
     - 考虑Worker当前负载情况
   - **分组策略**:
     - 按资源分组（生产任务只分配到生产Worker）
     - 支持任务指定Worker

4. **调度限流**
   - 全局调度速率限制（QPS）
   - 单Worker调度速率限制
   - 防止调度风暴

#### 4.1.3 日志收集与展示

**日志收集**:

1. **日志接收**
   - Worker通过Netty上报日志到Master
   - 日志分批上报（每100行或每秒上报一次）
   - 支持日志压缩传输

2. **日志存储**
   - 实时日志存入缓存（Redis）供实时查询
   - 历史日志异步写入日志存储（ClickHouse/ES）
   - 大日志分片存储（单文件超过10MB分片）

3. **日志聚合**
   - 多Worker执行任务的日志聚合
   - 日志时序排序
   - 日志元数据（实例ID、时间戳、级别等）

**日志展示**:

1. **实时日志**
   - WebSocket推送实时日志到前端
   - 支持暂停/继续日志流
   - 自动滚动到底部

2. **历史日志**
   - 分页加载历史日志
   - 支持关键字搜索
   - 支持按时间范围筛选

#### 4.1.4 Master高可用

**集群部署**:
- 多Master节点（建议3个或5个）
- 基于Raft协议或Zookeeper实现主节点选举
- Active-Standby模式（一主多备）

**故障转移**:
- Master宕机后自动选举新的主节点
- 接管调度任务与Worker管理
- 故障恢复后自动同步状态

**数据一致性**:
- 调度状态存储在数据库
- 使用分布式锁保证调度幂等性

### 4.2 Worker节点详细设计

#### 4.2.1 任务执行引擎

**执行器抽象**:

```
interface TaskExecutor {
    ExecuteResult execute(TaskInstance instance);
    void cancel(String instanceId);
    boolean isSupported(TaskType type);
}
```

**支持的执行器类型**:

1. **SQL执行器**
   - 支持多种数据源（MySQL、Hive、ClickHouse、SparkSQL）
   - JDBC连接池管理
   - SQL语法校验
   - 执行结果集处理

2. **Shell执行器**
   - 进程管理（创建、监控、销毁）
   - 标准输出/错误输出捕获
   - 超时控制
   - 进程信号处理（SIGTERM、SIGKILL）

3. **Python执行器**
   - 虚拟环境隔离
   - 依赖管理
   - 输出流捕获

4. **Spark执行器**
   - Spark任务提交（spark-submit）
   - 任务状态监控
   - 日志收集

**执行流程**:

```
1. 接收Master分配的任务实例
2. 解析任务配置与参数
3. 选择对应的执行器
4. 执行前置检查（资源、权限等）
5. 启动执行器执行任务
6. 实时捕获日志并上报Master
7. 监控执行状态（超时、资源使用）
8. 执行完成后上报结果
9. 清理执行环境
```

#### 4.2.2 日志上报机制

**上报策略**:

1. **批量上报**
   - 日志缓冲区（默认100行）
   - 定时刷新（每秒）
   - 执行完成时立即刷新剩余日志

2. **上报协议**
   - 消息类型: LOG_REPORT
   - 消息体: 实例ID + 日志批次 + 日志内容
   - 支持压缩（Gzip）

3. **失败重试**
   - 上报失败自动重试（最多3次）
   - 失败后本地持久化日志
   - 恢复后补传日志

#### 4.2.3 状态管理

**实例状态机**:

```
WAITING（等待中）
    ↓
RUNNING（运行中）
    ↓
SUCCESS（成功） / FAILED（失败） / CANCELED（已取消）
```

**状态上报**:

1. **状态变更上报**
   - 状态变化时立即上报Master
   - 携带状态变更原因

2. **心跳上报**
   - 运行中的任务定期上报心跳（30秒）
   - 携带任务进度信息（可选）

3. **超时检测**
   - Worker本地检测任务超时
   - 超时后主动终止任务并上报FAILED状态

#### 4.2.4 资源隔离

**进程隔离**:
- 每个任务独立进程执行
- 进程资源限制（CPU、内存）

**网络隔离**:
- 限制任务访问外部网络（可选）
- 白名单机制

**文件隔离**:
- 每个任务独立工作目录
- 执行完成后清理临时文件

### 4.3 Netty通信详细设计

#### 4.3.1 通信协议

**协议格式**:

```
+--------+--------+----------+------------+---------+
| 魔数   | 版本   | 消息类型 | 消息体长度 | 消息体   |
| 4字节  | 1字节  | 1字节    | 4字节      | N字节   |
+--------+--------+----------+------------+---------+
```

- **魔数**: 0xCAFEBABE（用于识别非法数据包）
- **版本**: 协议版本号，当前为1
- **消息类型**:
  - 0x01: 心跳请求
  - 0x02: 心跳响应
  - 0x03: 任务分配
  - 0x04: 任务执行状态上报
  - 0x05: 日志上报
  - 0x06: 取消任务
  - 0x07: Worker注册
  - 0x08: Worker注销
- **消息体长度**: 消息体字节数
- **消息体**: Protobuf或JSON序列化后的数据

#### 4.3.2 消息定义

**心跳消息**:

```protobuf
message HeartbeatRequest {
    string workerId = 1;
    int64 timestamp = 2;
    WorkerStatus status = 3;
}

message HeartbeatResponse {
    string masterId = 1;
    int64 timestamp = 2;
}
```

**任务分配消息**:

```protobuf
message TaskAssignRequest {
    string instanceId = 1;
    string taskId = 2;
    TaskType taskType = 3;
    string taskCode = 4;
    map<string, string> params = 5;
    int32 timeout = 6;
    int32 priority = 7;
}

message TaskAssignResponse {
    string instanceId = 1;
    bool accepted = 2;
    string reason = 3;
}
```

**状态上报消息**:

```protobuf
message StatusReportRequest {
    string instanceId = 1;
    InstanceStatus status = 2;
    int64 startTime = 3;
    int64 endTime = 4;
    string errorMsg = 5;
}
```

**日志上报消息**:

```protobuf
message LogReportRequest {
    string instanceId = 1;
    repeated LogLine logs = 2;
}

message LogLine {
    int64 timestamp = 1;
    LogLevel level = 2;
    string content = 3;
}
```

#### 4.3.3 连接管理

**长连接管理**:

1. **连接建立**
   - Worker启动后主动连接Master
   - 支持Master地址列表（高可用）
   - 连接建立后发送注册消息

2. **心跳保活**
   - Worker每30秒发送心跳到Master
   - Master超过60秒未收到心跳则标记Worker为离线
   - 心跳失败自动重连

3. **断线重连**
   - 指数退避重连策略（1s、2s、4s、8s...最大60s）
   - 重连成功后重新注册
   - 上报本地运行中的任务状态

**连接池**:
- Master维护Worker连接池
- 复用连接发送消息
- 自动清理失效连接

#### 4.3.4 负载均衡

**Master侧负载均衡**:

1. **任务分配策略**
   - 基于Worker负载（CPU、内存、任务数）
   - 加权轮询算法
   - 考虑任务资源需求

2. **Worker健康检查**
   - 定期检查Worker心跳
   - 资源使用率监控
   - 自动剔除不健康Worker

**流量控制**:
- 限制Master到Worker的消息发送速率
- 防止Worker过载
- 支持任务队列堆积告警

#### 4.3.5 异常处理

**超时处理**:
- 消息发送超时（默认10秒）
- 任务执行超时（按任务配置）
- 心跳超时（60秒）

**异常恢复**:
- 消息发送失败自动重试
- 连接断开自动重连
- 任务执行失败自动重试（按配置）

**容错机制**:
- Worker宕机后任务自动重新调度
- Master宕机后Worker自动连接新Master
- 网络闪断不影响正在执行的任务

---

## 5. 数据库设计

### 5.1 核心表结构

#### 5.1.1 任务表（t_task）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | bigint | 主键ID | PRIMARY |
| task_name | varchar(128) | 任务名称 | UNIQUE |
| task_code | text | 任务代码 | - |
| task_type | varchar(32) | 任务类型 | INDEX |
| description | varchar(512) | 任务描述 | - |
| directory_id | bigint | 所属目录ID | INDEX |
| cron_expr | varchar(128) | Cron表达式 | - |
| offset_days | int | 偏移天数 | - |
| timeout | int | 超时时间（分钟） | - |
| retry_times | int | 重试次数 | - |
| retry_interval | int | 重试间隔（分钟） | - |
| priority | varchar(16) | 优先级 | - |
| owner | varchar(256) | 责任人 | INDEX |
| subject | varchar(64) | 所属主题 | INDEX |
| status | varchar(16) | 任务状态 | INDEX |
| resource_group | varchar(64) | 资源分组 | - |
| max_concurrent | int | 最大并发数 | - |
| create_time | datetime | 创建时间 | INDEX |
| update_time | datetime | 更新时间 | INDEX |
| create_by | varchar(64) | 创建人 | - |
| update_by | varchar(64) | 更新人 | - |

#### 5.1.2 任务依赖表（t_task_dependency）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | bigint | 主键ID | PRIMARY |
| task_id | bigint | 任务ID | INDEX |
| depend_task_id | bigint | 依赖任务ID | INDEX |
| depend_type | varchar(16) | 依赖类型 | - |
| cycle_offset | int | 周期偏移 | - |
| create_time | datetime | 创建时间 | - |

复合唯一索引: (task_id, depend_task_id)

#### 5.1.3 任务实例表（t_task_instance）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | bigint | 主键ID | PRIMARY |
| instance_name | varchar(256) | 实例名称 | - |
| task_id | bigint | 任务ID | INDEX |
| task_snapshot | text | 任务配置快照 | - |
| business_date | date | 业务日期 | INDEX |
| status | varchar(16) | 实例状态 | INDEX |
| trigger_type | varchar(16) | 触发方式 | - |
| start_time | datetime | 开始时间 | INDEX |
| end_time | datetime | 结束时间 | - |
| execute_time | int | 执行耗时（秒） | - |
| worker_id | varchar(64) | 执行Worker | INDEX |
| retry_times | int | 已重试次数 | - |
| error_msg | text | 错误信息 | - |
| create_time | datetime | 创建时间 | INDEX |

复合唯一索引: (task_id, business_date, create_time)
复合索引: (status, create_time)

#### 5.1.4 实例日志表（t_instance_log）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | bigint | 主键ID | PRIMARY |
| instance_id | bigint | 实例ID | INDEX |
| log_content | text | 日志内容 | - |
| log_level | varchar(16) | 日志级别 | - |
| log_time | datetime | 日志时间 | - |
| create_time | datetime | 创建时间 | - |

复合索引: (instance_id, log_time)

建议: 日志量大时使用ClickHouse或Elasticsearch存储

#### 5.1.5 服务器表（t_server）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | bigint | 主键ID | PRIMARY |
| server_name | varchar(128) | 服务器名称 | - |
| ip_address | varchar(64) | IP地址 | UNIQUE |
| server_role | varchar(16) | 服务器角色 | INDEX |
| resource_group | varchar(64) | 资源分组 | INDEX |
| status | varchar(16) | 服务器状态 | INDEX |
| cpu_cores | int | CPU核数 | - |
| memory_size | bigint | 内存大小（MB） | - |
| max_task_num | int | 最大任务数 | - |
| current_task_num | int | 当前任务数 | - |
| last_heartbeat | datetime | 最后心跳时间 | INDEX |
| create_time | datetime | 创建时间 | - |
| update_time | datetime | 更新时间 | - |

#### 5.1.6 目录表（t_directory）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | bigint | 主键ID | PRIMARY |
| directory_name | varchar(128) | 目录名称 | - |
| parent_id | bigint | 父目录ID | INDEX |
| directory_path | varchar(512) | 目录路径 | INDEX |
| owner | varchar(64) | 责任人 | - |
| create_time | datetime | 创建时间 | - |
| update_time | datetime | 更新时间 | - |

---

## 6. 非功能性需求

### 6.1 性能要求

| 指标 | 要求 |
|-----|------|
| 任务调度并发数 | 支持10000个任务并发调度 |
| 单机Worker执行能力 | 单Worker支持100个任务并发执行 |
| 实例生成延迟 | 调度时间到达后1分钟内生成实例 |
| 任务分配延迟 | 实例生成后10秒内分配到Worker |
| 日志查询响应时间 | 90分位耗时 < 2秒 |
| DAG图渲染时间 | 1000节点DAG图渲染 < 3秒 |
| 界面响应时间 | 列表查询90分位耗时 < 1秒 |
| 数据库查询性能 | 慢查询（>1秒）占比 < 1% |

### 6.2 可用性要求

| 指标 | 要求 |
|-----|------|
| 系统可用性 | 99.9%（年停机时间<8.76小时） |
| Master高可用 | 支持多Master部署，故障转移时间<30秒 |
| Worker故障恢复 | Worker宕机后任务自动重新调度到其他Worker |
| 数据持久化 | 任务元数据、实例信息、日志持久化存储 |
| 备份恢复 | 数据库每日全量备份，支持7天内任意时间点恢复 |

### 6.3 可扩展性要求

| 维度 | 要求 |
|-----|------|
| 水平扩展 | 支持动态增加Worker节点，无需重启服务 |
| 任务规模 | 支持10万级任务管理 |
| 实例规模 | 支持千万级实例历史数据查询 |
| 日志规模 | 支持PB级日志存储与查询 |
| 插件化 | 支持自定义任务类型插件 |

### 6.4 安全性要求

**认证授权**:
- 用户登录认证（LDAP/OAuth2.0/SSO）
- 基于RBAC的权限控制
- 任务级别权限（查看/编辑/执行/删除）
- 目录级别权限继承

**数据安全**:
- 敏感数据加密存储（数据库连接密码等）
- 传输层加密（HTTPS、TLS）
- 操作审计日志
- 数据脱敏（日志中的敏感信息）

**代码安全**:
- SQL注入防护
- 脚本命令注入防护
- 禁止执行危险命令
- 代码审计与扫描

### 6.5 可维护性要求

**监控告警**:
- Master/Worker节点监控（CPU、内存、网络）
- 任务执行监控（成功率、耗时、失败告警）
- 系统运行监控（调度延迟、队列堆积）
- 告警渠道（邮件、短信、钉钉、企业微信）

**日志管理**:
- 系统日志分级（DEBUG/INFO/WARN/ERROR）
- 日志集中收集（ELK/Splunk）
- 日志保留策略（分级保留）
- 日志查询与分析

**运维工具**:
- 健康检查接口（/health）
- 指标暴露接口（Prometheus格式）
- 配置热更新（无需重启）
- 数据清理工具（清理历史数据）

### 6.6 兼容性要求

**浏览器兼容**:
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

**数据库兼容**:
- MySQL 5.7+
- PostgreSQL 12+

**任务类型兼容**:
- SQL: MySQL、Hive、SparkSQL、ClickHouse、Presto
- Shell: Bash、Zsh
- Python: 2.7、3.6+
- 其他: 支持插件扩展

---

## 7. 接口设计

### 7.1 API接口规范

**RESTful API设计原则**:
- 使用标准HTTP方法（GET/POST/PUT/DELETE）
- 统一响应格式
- 版本管理（/api/v1/）
- 认证方式（Token/JWT）

**统一响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1642665600000
}
```

### 7.2 核心接口列表

#### 7.2.1 任务管理接口

| 接口 | 方法 | 说明 |
|-----|------|------|
| /api/v1/tasks | GET | 查询任务列表 |
| /api/v1/tasks/{id} | GET | 查询任务详情 |
| /api/v1/tasks | POST | 创建任务 |
| /api/v1/tasks/{id} | PUT | 更新任务 |
| /api/v1/tasks/{id} | DELETE | 删除任务 |
| /api/v1/tasks/{id}/execute | POST | 手动执行任务 |
| /api/v1/tasks/{id}/dependencies | GET | 查询任务依赖 |
| /api/v1/tasks/{id}/dag | GET | 查询任务DAG图 |

#### 7.2.2 实例管理接口

| 接口 | 方法 | 说明 |
|-----|------|------|
| /api/v1/instances | GET | 查询实例列表 |
| /api/v1/instances/{id} | GET | 查询实例详情 |
| /api/v1/instances/{id}/logs | GET | 查询实例日志 |
| /api/v1/instances/{id}/rerun | POST | 重跑实例 |
| /api/v1/instances/{id}/cancel | POST | 取消实例 |
| /api/v1/instances/{id}/dag | GET | 查询实例DAG图 |

#### 7.2.3 服务器管理接口

| 接口 | 方法 | 说明 |
|-----|------|------|
| /api/v1/servers | GET | 查询服务器列表 |
| /api/v1/servers/{id} | GET | 查询服务器详情 |
| /api/v1/servers/{id}/monitor | GET | 查询服务器监控数据 |
| /api/v1/servers/{id}/tasks | GET | 查询服务器运行任务 |

---

## 8. 部署架构

### 8.1 推荐部署架构

**生产环境**:

```
┌─────────────────────────────────────────────────────┐
│                   负载均衡（Nginx/LVS）              │
└─────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────┐
│              Web应用集群（至少2个节点）              │
└─────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────┐
│             Master集群（3个或5个节点）               │
└─────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────┐
│              Worker集群（按需扩展）                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │ Worker 1 │  │ Worker 2 │  │ Worker N │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└─────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────┐
│                    基础设施层                        │
│  MySQL主从 | Redis集群 | ClickHouse | Zookeeper    │
└─────────────────────────────────────────────────────┘
```

**资源规格建议**:

| 组件 | 规格 | 数量 | 说明 |
|-----|------|------|------|
| Web应用 | 4C8G | 2+ | 可根据访问量扩展 |
| Master | 8C16G | 3 | 建议奇数个节点 |
| Worker | 16C32G | N | 根据任务量扩展 |
| MySQL | 8C16G 500G SSD | 1主2从 | 主从复制 |
| Redis | 4C8G | 3节点集群 | 哨兵模式 |
| Zookeeper | 4C8G | 3 | 注册中心/分布式锁 |

### 8.2 网络规划

**网络隔离**:
- Web层: 公网访问（HTTPS）
- 应用层: 内网通信
- 数据层: 内网隔离

**端口规划**:
- Web应用: 8080（内部）、443（外部）
- Master: 9090（管理端口）、9091（Netty通信端口）
- Worker: 9092（Netty通信端口）
- MySQL: 3306
- Redis: 6379
- Zookeeper: 2181

---

## 9. 实施计划

### 9.1 项目阶段划分

**第一阶段: 核心功能开发**
- 任务管理模块
- 任务实例生成与调度
- Master/Worker通信框架
- 基础任务执行器（SQL、Shell）

**第二阶段: 完善功能**
- 任务依赖管理
- DAG可视化
- 日志收集与展示
- 服务器管理

**第三阶段: 高级功能**
- 高可用架构
- 性能优化
- 监控告警
- 权限管理

**第四阶段: 优化与扩展**
- 用户体验优化
- 插件化架构
- 更多任务类型支持
- 数据质量监控

### 9.2 里程碑

| 里程碑 | 交付物 | 验收标准 |
|-------|-------|---------|
| M1: 核心框架 | Master/Worker通信、基础调度能力 | 能够调度执行SQL任务 |
| M2: 功能完善 | 任务管理、实例管理、依赖管理 | 完成核心功能开发 |
| M3: 可用性增强 | 高可用架构、监控告警 | 系统可用性达到99% |
| M4: 生产就绪 | 性能优化、安全加固、文档完善 | 支持生产环境部署 |

---

## 10. 附录

### 10.1 术语表

| 术语 | 说明 |
|-----|------|
| 任务（Task） | 调度系统中的最小调度单元，定义了要执行的工作内容 |
| 实例（Instance） | 任务在某个特定时间点或业务日期的执行记录 |
| DAG | 有向无环图，用于表示任务之间的依赖关系 |
| Master | 调度系统的管理节点，负责任务调度和管理 |
| Worker | 调度系统的执行节点，负责实际执行任务 |
| 业务日期 | 任务处理的数据所属日期，可能与实际执行时间不同 |
| 调度时间 | 任务预定执行的时间点 |
| 偏移量 | 业务日期相对于调度时间的偏移 |
| Cron表达式 | 定时任务的时间表达式 |

### 10.2 参考资料

- Apache DolphinScheduler: https://dolphinscheduler.apache.org/
- Apache Airflow: https://airflow.apache.org/
- Netty官方文档: https://netty.io/
- Quartz调度框架: http://www.quartz-scheduler.org/

---

**文档结束**

> 本文档版本: V1.0
> 最后更新时间: 2026-01-20
> 文档维护: 系统架构组
